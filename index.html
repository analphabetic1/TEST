<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¾ é¬¥åœ°ä¸»è¨ˆåˆ†åŠ©æ‰‹ Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --poodle-brown: #795548; 
            --poodle-light: #D7CCC8; 
            --poodle-cream: #F5F5DC;
            --poodle-accent: #8D6E63;
            --white: #FFFFFF;
            --danger: #d32f2f;
        }
        body { font-family: sans-serif; background: var(--poodle-cream); margin: 0; padding: 20px; color: #4E342E; }
        .page { display: none; max-width: 500px; margin: auto; }
        .page.active { display: block; }
        
        /* çµ±ä¸€æ–¹å¡Šæ¨£å¼ */
        .card { background: var(--white); padding: 20px; border-radius: 20px; box-shadow: 0 4px 10px rgba(121, 85, 72, 0.15); margin-bottom: 20px; border: 1px solid var(--poodle-light); }
        
        h2 { text-align: center; color: var(--poodle-brown); margin-bottom: 15px; font-size: 1.5rem; }
        h3 { margin-top: 0; font-size: 1rem; color: var(--poodle-accent); padding-bottom: 10px; border-bottom: 1px dashed var(--poodle-light); margin-bottom: 15px; }

        .score-board { display: flex; justify-content: space-around; background: var(--poodle-brown); border-radius: 15px; padding: 15px; color: var(--white); margin-bottom: 15px; }
        .stats-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; text-align: center; }
        .stats-table th { color: var(--poodle-accent); padding: 5px; border-bottom: 1px solid var(--poodle-light); }
        .stats-table td { padding: 8px 5px; border-bottom: 1px solid #f9f9f9; }

        .box-selector { display: flex; gap: 8px; margin: 10px 0; }
        .box-item { flex: 1; padding: 12px 5px; border: 2px solid var(--poodle-light); border-radius: 12px; text-align: center; cursor: pointer; font-weight: bold; }
        .box-item.active { border-color: var(--poodle-brown); color: var(--white); background: var(--poodle-brown); }
        .box-item.winner.active { border-color: #689F38; color: var(--white); background: #689F38; }

        .btn-main { background: var(--poodle-accent); color: var(--white); border: none; cursor: pointer; width: 100%; font-size: 1.1rem; font-weight: bold; padding: 15px; border-radius: 12px; margin-top: 15px; }
        .btn-back { background: transparent; color: var(--poodle-brown); border: 1px solid var(--poodle-brown); padding: 5px 15px; border-radius: 20px; cursor: pointer; margin-bottom: 10px; }

        .session-item { padding: 18px; background: var(--white); border-radius: 15px; margin-bottom: 12px; border: 1px solid var(--poodle-light); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        
        /* æ­·å²ç´€éŒ„æ¨£å¼å„ªåŒ– */
        .history-container { padding: 0; }
        .history-item { border-bottom: 1px solid #efebe9; padding: 15px 0; font-size: 0.95rem; display: flex; align-items: center; justify-content: space-between; }
        .history-item:last-child { border-bottom: none; }
        .round-num { display: inline-block; width: 34px; height: 34px; line-height: 34px; background: var(--poodle-light); color: var(--poodle-brown); border-radius: 50%; text-align: center; font-weight: bold; margin-right: 12px; font-size: 0.8rem; flex-shrink: 0; }
        .history-item.deleted { opacity: 0.4; filter: grayscale(1); }
        .del-btn { background: #FFEBEE; color: var(--danger); border: none; padding: 8px 12px; border-radius: 10px; cursor: pointer; font-size: 0.85rem; }

        /* å¯†ç¢¼æ“‹æ¿æ¨£å¼ */
        #passwordOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--poodle-cream); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .pw-card { width: 85%; max-width: 320px; text-align: center; }
        #pwInput { 
            width: 100%; padding: 12px; box-sizing: border-box; 
            border-radius: 10px; border: 1px solid var(--poodle-light); 
            margin-bottom: 15px; font-size: 1rem;
        }
    </style>
</head>
<body>

    <div id="passwordOverlay">
        <div class="card pw-card">
            <h3>ğŸ”’ é€²å…¥æ¬Šé™é©—è­‰</h3>
            <input type="password" id="pwInput" placeholder="1688">
            <button class="btn-main" onclick="checkPassword()">é€²å…¥ç³»çµ±</button>
            <p id="pwMsg" style="color:var(--danger); font-size:0.8rem; margin-top:10px;"></p>
        </div>
    </div>

    <div id="lobbyPage" class="page active">
        <h2>ğŸ¾ é¬¥åœ°ä¸»è¨ˆåˆ†å¤§å»³</h2>
        <div class="card">
            <h3>ğŸ‘¤ ç¬¬ä¸€æ­¥ï¼šé¸æ“‡æˆ‘æ˜¯èª°</h3>
            <div class="box-selector" id="lobbyMeSelector">
                <div class="box-item" onclick="setMe('A', this)">æˆ‘æ˜¯ A</div>
                <div class="box-item" onclick="setMe('E', this)">æˆ‘æ˜¯ E</div>
                <div class="box-item" onclick="setMe('D', this)">æˆ‘æ˜¯ D</div>
            </div>
            <p id="meDisplay" style="text-align:center; font-size:0.85rem; color:var(--poodle-brown); margin:5px 0 0 0;">(é€²å…¥è³½å±€å‰è«‹å…ˆé¸æ“‡èº«åˆ†)</p>
        </div>
        <div class="card">
            <h3>ğŸ¾ ç¬¬äºŒæ­¥ï¼šé€²å…¥æˆ–æ–°å¢è³½å±€</h3>
            <div style="display:flex; flex-direction:column; gap:12px; margin-top:10px;">
                <input type="text" id="newSessionInput" placeholder="è³½å±€åç¨± (å¦‚ 0101)" style="padding:12px; border-radius:10px; border:1px solid var(--poodle-light);">
                <div style="font-size:0.9rem;">åº•åˆ†ï¼š<input type="number" id="baseScoreInput" value="10" style="width:70px; padding:8px; border-radius:8px; border:1px solid var(--poodle-light);"></div>
                <button class="btn-main" onclick="createSession()">å»ºç«‹æ–°è³½å±€</button>
            </div>
        </div>
        <div id="sessionList">é€£ç·šä¸­...</div>
    </div>

    <div id="gamePage" class="page">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <button class="btn-back" onclick="showLobby()">â¬… è¿”å›å¤§å»³</button>
            <span id="headerMe" style="font-size:0.9rem; color:var(--poodle-brown); font-weight:bold;">æ“ä½œè€…ï¼š-</span>
        </div>
        
        <div class="card" style="background: var(--poodle-cream); border:none;">
            <h2 id="currentSessionTitle" style="margin:0 0 10px 0; font-size:1.2rem;">è³½å±€è©³æƒ…</h2>
            <div class="score-board">
                <div class="player">A<div id="scoreA" style="font-size:26px; font-weight:bold;">0</div></div>
                <div class="player">E<div id="scoreE" style="font-size:26px; font-weight:bold;">0</div></div>
                <div class="player">D<div id="scoreD" style="font-size:26px; font-weight:bold;">0</div></div>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“ˆ æˆ°ç¸¾çµ±è¨ˆ</h3>
            <table class="stats-table">
                <thead><tr><th>ç©å®¶</th><th>å‹å ´</th><th>å‹ç‡</th><th>åœ°ä¸»å‹ç‡</th><th>è¾²æ°‘å‹ç‡</th></tr></thead>
                <tbody id="statsBody"></tbody>
            </table>
        </div>

        <div class="card">
            <h3>ğŸƒ æäº¤å›åˆ</h3>
            <div style="font-size:0.85rem;">åœ°ä¸»ï¼š</div>
            <div class="box-selector" id="landlordSelector">
                <div class="box-item" onclick="setLandlord('A', this)">A</div>
                <div class="box-item" onclick="setLandlord('E', this)">E</div>
                <div class="box-item" onclick="setLandlord('D', this)">D</div>
            </div>
            <div style="margin:10px 0 5px 0; font-size:0.85rem;">çµæœï¼š</div>
            <div class="box-selector" id="winnerSelector">
                <div class="box-item winner" onclick="setWinner('landlord', this)">åœ°ä¸»è´</div>
                <div class="box-item winner" onclick="setWinner('farmers', this)">è¾²æ°‘è´</div>
            </div>
            <div style="margin:15px 0 5px 0; font-size:0.85rem; display:flex; gap:10px;">
                <label><input type="checkbox" id="rocket"> ğŸš€ ç«ç®­</label>
                <label><input type="checkbox" id="spring"> ğŸŒ¸ æ˜¥å¤©</label>
            </div>
            <div style="margin-top:10px;">
                <span>ğŸ’£ ç‚¸å½ˆ: <b id="bombVal">0</b></span>
                <input type="range" id="bombs" min="0" max="7" value="0" style="width:100%" oninput="bombVal.innerText=this.value">
            </div>
            <button class="btn-main" onclick="submitRound()">æäº¤ç´€éŒ„</button>
        </div>

        <div class="card">
            <h3>ğŸ“œ æ­·å²ç´€éŒ„</h3>
            <div id="roundHistory" class="history-container"></div>
        </div>
    </div>

<script>
    // --- å¯†ç¢¼èˆ‡æ¬Šé™é‚è¼¯ ---
    const ACCESS_PASSWORD = "ä½ çš„å¯†ç¢¼"; // è«‹åœ¨æ­¤è¨­å®šä½ çš„å¯†ç¢¼
    
    function checkPassword() {
        const input = document.getElementById('pwInput').value;
        const msg = document.getElementById('pwMsg');
        
        if (input === ACCESS_PASSWORD) {
            localStorage.setItem('poodle_score_auth', 'permanent_verified');
            document.getElementById('passwordOverlay').style.display = 'none';
        } else {
            msg.innerText = "å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥";
        }
    }

    function validateAuth() {
        const authStatus = localStorage.getItem('poodle_score_auth');
        if (authStatus === 'permanent_verified') {
            document.getElementById('passwordOverlay').style.display = 'none';
        }
    }

    // --- åŸæœ‰ Supabase é‚è¼¯ ---
    const SB_URL = "https://mmnauzvhnguffpmevrup.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tbmF1enZobmd1ZmZwbWV2cnVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MjI1NjcsImV4cCI6MjA4MzE5ODU2N30.8GUyft8yVecvju7ecjcBwt1j2aqDL-WjThLA17iOcoE";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let currentSession = "", currentBase = 10, myName = "", selectedLandlord = "", selectedWinner = "";

    function showLobby() {
        document.getElementById('lobbyPage').classList.add('active');
        document.getElementById('gamePage').classList.remove('active');
        fetchSessions();
    }

    async function fetchSessions() {
        const { data } = await _supabase.from('sessions').select('*').order('created_at', { ascending: false });
        document.getElementById('sessionList').innerHTML = data?.map(s => `
            <div class="session-item" onclick="checkAndEnter('${s.name}', ${s.base_score})">
                <b>ğŸ¾ ${s.name}</b>
                <span style="color:var(--poodle-accent)">åº•åˆ†:${s.base_score} ></span>
            </div>
        `).join('') || "ç›®å‰ç„¡è³½å±€";
    }

    function setMe(v, el) { 
        myName = v; 
        document.querySelectorAll('#lobbyMeSelector .box-item').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('meDisplay').innerText = `å·²é¸æ“‡èº«åˆ†ï¼š${v}`;
        document.getElementById('headerMe').innerText = `æ“ä½œè€…ï¼š${v}`;
    }

    function checkAndEnter(name, base) {
        if(!myName) return alert("è«‹å…ˆåœ¨å¤§å»³é¸æ“‡èº«åˆ†ï¼");
        enterSession(name, base);
    }

    function enterSession(name, base) {
        currentSession = name; currentBase = base;
        document.getElementById('currentSessionTitle').innerText = `è³½å±€ï¼š${name}`;
        document.getElementById('lobbyPage').classList.remove('active');
        document.getElementById('gamePage').classList.add('active');
        refreshGameData();
    }

    async function createSession() {
        if(!myName) return alert("è«‹å…ˆé¸æ“‡èº«åˆ†ï¼");
        const name = document.getElementById('newSessionInput').value.trim();
        const base = parseInt(document.getElementById('baseScoreInput').value);
        if(!name) return;
        const { error } = await _supabase.from('sessions').insert([{ name, base_score: base }]);
        if(error) alert("å»ºç«‹å¤±æ•—(å¯èƒ½åç¨±é‡è¤‡)"); else fetchSessions();
    }

    function setLandlord(v, el) { 
        selectedLandlord = v; 
        document.querySelectorAll('#landlordSelector .box-item').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }
    function setWinner(v, el) { 
        selectedWinner = v; 
        document.querySelectorAll('#winnerSelector .box-item').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }

    async function submitRound() {
        if(!selectedLandlord || !selectedWinner) return alert("è«‹å®Œæˆé¸æ“‡");
        const bombs = parseInt(document.getElementById('bombs').value);
        const power = bombs + (document.getElementById('rocket').checked ? 1 : 0) + (document.getElementById('spring').checked ? 1 : 0);
        await _supabase.from('history').insert([{
            session_name: currentSession, added_by: myName, landlord: selectedLandlord,
            win_loss: selectedWinner === 'landlord' ? 'è´' : 'è¼¸',
            points: currentBase * Math.pow(2, power)
        }]);
        refreshGameData();
        document.getElementById('rocket').checked = false;
        document.getElementById('spring').checked = false;
        document.getElementById('bombs').value = 0;
        document.getElementById('bombVal').innerText = "0";
    }

    async function refreshGameData() {
        const { data } = await _supabase.from('history').select('*').eq('session_name', currentSession).order('created_at', { ascending: true });
        let s = { A: 0, E: 0, D: 0 };
        let stats = { A: { w: 0, t: 0, lw: 0, lt: 0, fw: 0, ft: 0 }, E: { w: 0, t: 0, lw: 0, lt: 0, fw: 0, ft: 0 }, D: { w: 0, t: 0, lw: 0, lt: 0, fw: 0, ft: 0 } };
        let rCounter = 0;

        const processed = data?.map(h => {
            if(!h.is_deleted) {
                rCounter++;
                const isLWin = h.win_loss === 'è´';
                const p = h.points;
                ['A','E','D'].forEach(n => {
                    stats[n].t++;
                    if(h.landlord === n) { stats[n].lt++; if(isLWin) { stats[n].w++; stats[n].lw++; } }
                    else { stats[n].ft++; if(!isLWin) { stats[n].w++; stats[n].fw++; } }
                });
                if(h.landlord === 'A') { s.A += (isLWin?p*2:-p*2); s.E += (isLWin?-p:p); s.D += (isLWin?-p:p); }
                else if(h.landlord === 'E') { s.E += (isLWin?p*2:-p*2); s.A += (isLWin?-p:p); s.D += (isLWin?-p:p); }
                else if(h.landlord === 'D') { s.D += (isLWin?p*2:-p*2); s.A += (isLWin?-p:p); s.E += (isLWin?-p:p); }
                return { ...h, rNum: `R${rCounter}` };
            }
            return { ...h, rNum: 'DEL' };
        });

        document.getElementById('scoreA').innerText = s.A;
        document.getElementById('scoreE').innerText = s.E;
        document.getElementById('scoreD').innerText = s.D;

        const rate = (w, t) => t === 0 ? "0%" : (w/t*100).toFixed(0) + "%";
        document.getElementById('statsBody').innerHTML = ['A', 'E', 'D'].map(n => `
            <tr><td><b>${n}</b></td><td>${stats[n].w}</td><td>${rate(stats[n].w, stats[n].t)}</td><td>${rate(stats[n].lw, stats[n].lt)}</td><td>${rate(stats[n].fw, stats[n].ft)}</td></tr>
        `).join('');

        document.getElementById('roundHistory').innerHTML = [...processed].reverse().map(h => `
            <div class="history-item ${h.is_deleted ? 'deleted' : ''}">
                <div style="display:flex; align-items:center;">
                    <span class="round-num">${h.rNum}</span>
                    <div>
                        <b>${h.landlord}${h.win_loss}</b> 
                        <span style="color:var(--poodle-brown); font-weight:bold;">(${h.win_loss==='è´'?'+':''}${h.points*2})</span>
                        <br>
                        <small style="color:#999; font-size: 0.75rem;">æ–°å¢: ${h.added_by}</small>
                    </div>
                </div>
                ${!h.is_deleted ? `<button class="del-btn" onclick="deleteRound('${h.id}')">åˆªé™¤</button>` : `<small style="color:var(--danger)">å·²ç”± ${h.deleted_by} åˆªé™¤</small>`}
            </div>
        `).join('');
    }

    async function deleteRound(id) {
        if(confirm("ç¢ºå®šåˆªé™¤é€™å›åˆï¼Ÿ")) {
            await _supabase.from('history').update({ is_deleted: true, deleted_by: myName }).eq('id', id);
            refreshGameData();
        }
    }

    // åˆå§‹åŒ–å•Ÿå‹•
    window.onload = () => {
        validateAuth(); // æª¢æŸ¥æ°¸ä¹…æˆæ¬Š
        fetchSessions();
        _supabase.channel('any').on('postgres_changes', { event: '*', schema: 'public' }, () => refreshGameData()).subscribe();
    };
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ‹å‹é¬¥åœ°ä¸»è¨ˆåˆ†æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #4a90e2; --success: #4caf50; --danger: #f44336; --dark: #2c3e50; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; margin: 0; padding: 15px; color: var(--dark); }
        .container { max-width: 500px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 15px; }
        h3 { margin-top: 0; font-size: 1.1rem; border-left: 4px solid var(--primary); padding-left: 10px; }
        
        /* ç©å®¶é¸æ“‡ */
        .user-selector { display: flex; gap: 10px; margin: 15px 0; }
        .user-btn { flex: 1; padding: 12px; border: 2px solid #eee; border-radius: 10px; cursor: pointer; text-align: center; font-weight: bold; transition: 0.3s; }
        .user-btn.active { border-color: var(--primary); background: #eef5ff; color: var(--primary); }

        /* è¨ˆåˆ†æ¿ */
        .score-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .score-box { background: #f8f9fa; padding: 15px 5px; border-radius: 12px; text-align: center; }
        .score-num { font-size: 1.4rem; font-weight: bold; color: var(--primary); display: block; }

        /* æ§åˆ¶é … */
        .row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        select, input[type="number"] { padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 1rem; }
        
        /* æ»‘æ¡¿èˆ‡é–‹é—œæ¨£å¼ */
        .switch { position: relative; display: inline-block; width: 46px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(22px); }
        
        input[type="range"] { width: 60%; }

        /* æŒ‰éˆ• */
        .btn-submit { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        .btn-submit:active { transform: scale(0.98); opacity: 0.9; }

        /* æ­·å²ç´€éŒ„ */
        .history-list { font-size: 0.85rem; max-height: 180px; overflow-y: auto; }
        .history-item { padding: 8px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .tag { font-size: 0.7rem; padding: 2px 6px; background: #eee; border-radius: 4px; margin-left: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h3>ğŸ‘¤ ç™»å…¥èº«ä»½</h3>
        <div class="user-selector">
            <div class="user-btn" onclick="setMe('A', this)">A</div>
            <div class="user-btn" onclick="setMe('E', this)">E</div>
            <div class="user-btn" onclick="setMe('D', this)">D</div>
        </div>
        <small style="color: #888;">* å¿…é ˆå…ˆé¸æ“‡èº«ä»½æ‰èƒ½å¢åŠ è¨˜éŒ„</small>
    </div>

    <div class="card">
        <h3>ğŸ“Š å³æ™‚ç¸½åˆ†</h3>
        <div class="score-grid">
            <div class="score-box"><span>A</span><span id="scoreA" class="score-num">0</span></div>
            <div class="score-box"><span>E</span><span id="scoreE" class="score-num">0</span></div>
            <div class="score-box"><span>D</span><span id="scoreD" class="score-num">0</span></div>
        </div>
    </div>

    <div class="card">
        <h3>ğŸƒ å¢åŠ å±€æ•¸è¨˜éŒ„</h3>
        <div class="row">
            <span>åœ°ä¸»ï¼š</span>
            <select id="landlord"><option>A</option><option>E</option><option>D</option></select>
            <select id="winLoss"><option value="1">è´äº†</option><option value="-1">è¼¸äº†</option></select>
        </div>

        <div class="row">
            <span>ğŸš€ ç«ç®­ (x2)</span>
            <label class="switch"><input type="checkbox" id="rocket"><span class="slider"></span></label>
        </div>

        <div class="row">
            <span>ğŸŒ¸ æ˜¥å¤© (x2)</span>
            <label class="switch"><input type="checkbox" id="spring"><span class="slider"></span></label>
        </div>

        <div class="row">
            <span>ğŸ’£ ç‚¸å½ˆï¼š<b id="bombVal" style="color:var(--danger)">0</b></span>
            <input type="range" id="bombs" min="0" max="5" value="0" oninput="bombVal.innerText=this.value">
        </div>

        <div class="row">
            <span>åº•åˆ†ï¼š</span>
            <input type="number" id="baseScore" value="10" style="width: 80px;">
        </div>

        <button class="btn-submit" onclick="submitScore()">ç¢ºèªä¸Šå‚³</button>
    </div>

    <div class="card">
        <h3>ğŸ“œ æœ€è¿‘ç´€éŒ„</h3>
        <div id="historyList" class="history-list">è®€å–ä¸­...</div>
    </div>
</div>

<script>
    // --- é…ç½®å€ï¼šè«‹å¡«å…¥ä½ çš„ Supabase è³‡æ–™ ---
    const SB_URL = "https://mmnauzvhnguffpmevrup.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tbmF1enZobmd1ZmZwbWV2cnVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MjI1NjcsImV4cCI6MjA4MzE5ODU2N30.8GUyft8yVecvju7ecjcBwt1j2aqDL-WjThLA17iOcoE";
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    let myName = "";

    // 1. è¨­å®šä½¿ç”¨è€…
    function setMe(name, el) {
        myName = name;
        document.querySelectorAll('.user-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }

    // 2. æŠ“å–æ•¸æ“š
    async function refreshData() {
        // æŠ“ç¸½åˆ†
        const { data: players } = await supabaseClient.from('players').select('*').order('id');
        if(players) {
            document.getElementById('scoreA').innerText = players[0].total_score;
            document.getElementById('scoreE').innerText = players[1].total_score;
            document.getElementById('scoreD').innerText = players[2].total_score;
        }

        // æŠ“æ­·å²
        const { data: history } = await supabaseClient.from('history').select('*').order('created_at', { ascending: false }).limit(10);
        if(history) {
            document.getElementById('historyList').innerHTML = history.map(h => `
                <div class="history-item">
                    <div>
                        <b>${h.landlord}</b> ${h.win_loss === 'è´' ? '<span style="color:red">è´</span>' : '<span style="color:green">è¼¸</span>'} 
                        <b>${h.points > 0 ? '+' : ''}${h.points}</b>
                        <span class="tag">by ${h.added_by}</span>
                    </div>
                    <span style="color:#bbb; font-size:10px;">${new Date(h.created_at).toLocaleTimeString()}</span>
                </div>
            `).join('');
        }
    }

    // 3. ä¸Šå‚³ç´€éŒ„
    async function submitScore() {
        if(!myName) return alert("è«‹å…ˆé¸æ“‡èº«ä»½ï¼");
        
        const landlord = document.getElementById('landlord').value;
        const winLoss = parseInt(document.getElementById('winLoss').value);
        const base = parseInt(document.getElementById('baseScore').value);
        const hasRocket = document.getElementById('rocket').checked;
        const hasSpring = document.getElementById('spring').checked;
        const bombCount = parseInt(document.getElementById('bombs').value);

        // è¨ˆç®—åˆ†æ•¸ (åº•åˆ† * 2^æ‰€æœ‰ç¿»å€å› ç´ )
        let power = (hasRocket ? 1 : 0) + (hasSpring ? 1 : 0) + bombCount;
        let finalPoints = base * Math.pow(2, power);
        
        // æº–å‚™æ›´æ–°æ•¸æ“š
        // åœ°ä¸»è´ï¼šåœ°ä¸»å¾— 2xï¼Œè¾²æ°‘å„æ‰£ 1x
        // åœ°ä¸»è¼¸ï¼šåœ°ä¸»æ‰£ 2xï¼Œè¾²æ°‘å„å¾— 1x
        let pA = 0, pE = 0, pD = 0;
        let winStr = winLoss === 1 ? 'è´' : 'è¼¸';
        
        if (landlord === 'A') { pA = finalPoints * 2 * winLoss; pE = -finalPoints * winLoss; pD = -finalPoints * winLoss; }
        else if (landlord === 'E') { pE = finalPoints * 2 * winLoss; pA = -finalPoints * winLoss; pD = -finalPoints * winLoss; }
        else { pD = finalPoints * 2 * winLoss; pA = -finalPoints * winLoss; pE = -finalPoints * winLoss; }

        // å¯«å…¥è³‡æ–™åº«
        const { error } = await supabaseClient.from('history').insert([{
            added_by: myName, landlord, win_loss: winStr, points: (landlord === myName ? pA : (myName==='A'?pA:myName==='E'?pE:pD)), 
            is_rocket: hasRocket, is_spring: hasSpring, bombs: bombCount
        }]);

        // æ›´æ–°ç¸½åˆ† (ç°¡å–®åšæ³•ï¼šç›´æ¥åŠ çµ¦ players è¡¨)
        // è¨»ï¼šé€™éƒ¨åˆ†å»ºè­°åœ¨ Supabase ç”¨ RPC æˆ–å¤šå€‹ updateï¼Œé€™è£¡å…ˆåšæ­·å²å‘ˆç¾ã€‚
        // ç‚ºç°¡åŒ–æ¼”ç¤ºï¼Œæˆ‘å€‘å‡è¨­ç¸½åˆ†æ˜¯é€éæ­·å²ç´¯ç©ç®—çš„ï¼Œæˆ–åœ¨æ­¤ç™¼é€ä¸‰å€‹ update
        await updateScore('A', pA);
        await updateScore('E', pE);
        await updateScore('D', pD);

        if(!error) {
            alert("ä¸Šå‚³æˆåŠŸï¼");
            resetForm();
            refreshData();
        }
    }

    async function updateScore(name, offset) {
        const { data } = await supabaseClient.from('players').select('total_score').eq('name', name).single();
        await supabaseClient.from('players').update({ total_score: data.total_score + offset }).eq('name', name);
    }

    function resetForm() {
        document.getElementById('rocket').checked = false;
        document.getElementById('spring').checked = false;
        document.getElementById('bombs').value = 0;
        document.getElementById('bombVal').innerText = "0";
    }

    // å•Ÿå‹•èˆ‡å³æ™‚ç›£è½
    refreshData();
    supabaseClient.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: '*' }, () => refreshData()).subscribe();

</script>
</body>
</html>

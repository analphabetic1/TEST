<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¬¥åœ°ä¸»é›²ç«¯è¨ˆåˆ†å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #4a90e2; --success: #4caf50; --danger: #f44336; --bg: #f4f7f9; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; }
        .page { display: none; padding: 15px; max-width: 500px; margin: auto; }
        .page.active { display: block; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        
        /* å¤§å»³æ¨£å¼ */
        .session-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; margin-bottom: 10px; border-radius: 10px; cursor: pointer; border: 1px solid #eee; }
        .session-item:active { background: #f0f0f0; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-outline { border: 1px solid var(--primary); color: var(--primary); background: transparent; }
        .btn-del { background: #ffeded; color: var(--danger); border: none; padding: 5px 10px; border-radius: 5px; }

        /* æ–¹å¡Šå¼é¸æ“‡å™¨ */
        .box-selector { display: flex; gap: 8px; margin: 10px 0; }
        .box-item { flex: 1; padding: 15px 5px; border: 2px solid #eee; border-radius: 10px; text-align: center; cursor: pointer; font-weight: bold; }
        .box-item.active { border-color: var(--primary); background: #eef5ff; color: var(--primary); }
        .box-item.winner.active { border-color: var(--success); background: #f0f9f0; color: var(--success); }

        /* è¨ˆåˆ†æ¿ */
        .score-grid { display: flex; justify-content: space-around; background: #2c3e50; color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .score-val { font-size: 1.5rem; display: block; }

        /* æ­·å²ç´€éŒ„ */
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="lobbyPage" class="page active">
        <h2 style="text-align:center">ğŸ´ é¬¥åœ°ä¸»è¨ˆåˆ†å¤§å»³</h2>
        <div class="card">
            <h3>æ–°å¢è³½å±€</h3>
            <div style="display:flex; gap:10px;">
                <input type="text" id="newSessionInput" placeholder="è¼¸å…¥æ—¥æœŸæˆ–åç¨± (å¦‚ 0101)" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd;">
                <button class="btn btn-primary" style="width:auto" onclick="createSession()">å»ºç«‹</button>
            </div>
        </div>
        <h3>æ­·å²è³½å±€åˆ—è¡¨</h3>
        <div id="sessionList">è¼‰å…¥ä¸­...</div>
    </div>

    <div id="gamePage" class="page">
        <button class="btn btn-outline" onclick="showLobby()" style="margin-bottom:15px;">â¬… è¿”å›å¤§å»³</button>
        <h2 id="currentSessionDisplay" style="margin:5px 0">è³½å±€ï¼š---</h2>
        
        <div class="score-grid">
            <div style="text-align:center">A<span id="scoreA" class="score-val">0</span></div>
            <div style="text-align:center">E<span id="scoreE" class="score-val">0</span></div>
            <div style="text-align:center">D<span id="scoreD" class="score-val">0</span></div>
        </div>

        <div class="card">
            <h3>æˆ‘æ˜¯èª°ï¼Ÿ(æ“ä½œè€…)</h3>
            <div class="box-selector" id="meSelector">
                <div class="box-item" onclick="setMe('A')">A</div>
                <div class="box-item" onclick="setMe('E')">E</div>
                <div class="box-item" onclick="setMe('D')">D</div>
            </div>

            <h3>åœ°ä¸»æ˜¯èª°ï¼Ÿ</h3>
            <div class="box-selector" id="landlordSelector">
                <div class="box-item" onclick="setLandlord('A')">A</div>
                <div class="box-item" onclick="setLandlord('E')">E</div>
                <div class="box-item" onclick="setLandlord('D')">D</div>
            </div>

            <h3>èª°è´äº†ï¼Ÿ</h3>
            <div class="box-selector" id="winnerSelector">
                <div class="box-item winner" onclick="setWinner('landlord')">åœ°ä¸»è´</div>
                <div class="box-item winner" onclick="setWinner('farmers')">è¾²æ°‘è´</div>
            </div>

            <div style="margin: 15px 0;">
                <label><input type="checkbox" id="rocket"> ğŸš€ ç«ç®­ x2</label> &nbsp;
                <label><input type="checkbox" id="spring"> ğŸŒ¸ æ˜¥å¤© x2</label>
            </div>

            <div>
                <span>ğŸ’£ ç‚¸å½ˆæ•¸é‡: <b id="bombVal" style="color:red">0</b></span>
                <input type="range" id="bombs" min="0" max="7" value="0" step="1" style="width:100%" oninput="bombVal.innerText=this.value">
            </div>

            <button class="btn btn-primary" style="margin-top:20px" onclick="submitRound()">æäº¤ç´€éŒ„</button>
        </div>

        <div class="card">
            <h3>æœ¬å±€å›åˆç´€éŒ„</h3>
            <div id="roundHistory"></div>
        </div>
    </div>

<script>
    // ä¿®æ­£å¾Œçš„ API é€£ç·šè³‡è¨Š
    const SB_URL = "https://mmnauzvhnguffpmevrup.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tbmF1enZobmd1ZmZwbWV2cnVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MjI1NjcsImV4cCI6MjA4MzE5ODU2N30.8GUyft8yVecvju7ecjcBwt1j2aqDL-WjThLA17iOcoE";
    const supabase = supabase.createClient(SB_URL, SB_KEY);

    let currentSession = "";
    let myName = "", selectedLandlord = "", selectedWinner = "";

    // --- é é¢è·³è½‰é‚è¼¯ ---
    function showLobby() {
        document.getElementById('lobbyPage').classList.add('active');
        document.getElementById('gamePage').classList.remove('active');
        fetchSessions();
    }

    async function enterSession(name) {
        currentSession = name;
        document.getElementById('currentSessionDisplay').innerText = "è³½å±€ï¼š" + name;
        document.getElementById('lobbyPage').classList.remove('active');
        document.getElementById('gamePage').classList.add('active');
        refreshGameData();
    }

    // --- å¤§å»³åŠŸèƒ½ ---
    async function fetchSessions() {
        const { data } = await supabase.from('sessions').select('*').order('created_at', { ascending: false });
        const list = document.getElementById('sessionList');
        list.innerHTML = data.map(s => `
            <div class="session-item">
                <div onclick="enterSession('${s.name}')" style="flex:1"><b>${s.name}</b> <small style="color:#999">${new Date(s.created_at).toLocaleDateString()}</small></div>
                <button class="btn-del" onclick="deleteSession('${s.name}')">åˆªé™¤</button>
            </div>
        `).join('');
    }

    async function createSession() {
        const name = document.getElementById('newSessionInput').value.trim();
        if(!name) return;
        const { error } = await supabase.from('sessions').insert([{ name }]);
        if(error) alert("åç¨±é‡è¤‡æˆ–éŒ¯èª¤");
        document.getElementById('newSessionInput').value = "";
        fetchSessions();
    }

    async function deleteSession(name) {
        if(!confirm(`ç¢ºå®šè¦åˆªé™¤æ•´å€‹ ${name} è³½å±€ç´€éŒ„å—ï¼Ÿ`)) return;
        await supabase.from('sessions').delete().eq('name', name);
        await supabase.from('history').delete().eq('session_name', name); // åŒæ­¥åˆªé™¤è£¡é¢çš„å›åˆ
        fetchSessions();
    }

    // --- éŠæˆ²åŠŸèƒ½ ---
    function setMe(val) { myName = val; highlight('meSelector', val, 'æˆ‘æ˜¯ '); }
    function setLandlord(val) { selectedLandlord = val; highlight('landlordSelector', val); }
    function setWinner(val) { selectedWinner = val; highlight('winnerSelector', val === 'landlord' ? 'åœ°ä¸»è´' : 'è¾²æ°‘è´'); }

    function highlight(id, val, prefix = "") {
        document.querySelectorAll(`#${id} .box-item`).forEach(el => el.classList.toggle('active', el.innerText === prefix + val));
    }

    async function submitRound() {
        if(!myName || !selectedLandlord || !selectedWinner) return alert("è«‹å®Œæˆé¸æ“‡");
        const bombs = parseInt(document.getElementById('bombs').value);
        const rocket = document.getElementById('rocket').checked;
        const spring = document.getElementById('spring').checked;
        const points = 10 * Math.pow(2, bombs + (rocket?1:0) + (spring?1:0));

        await supabase.from('history').insert([{
            session_name: currentSession, added_by: myName, landlord: selectedLandlord,
            win_loss: selectedWinner === 'landlord' ? 'è´' : 'è¼¸',
            points, bombs, is_rocket: rocket, is_spring: spring
        }]);
        refreshGameData();
        // é‡ç½®æ¬„ä½
        document.getElementById('rocket').checked = false;
        document.getElementById('spring').checked = false;
        document.getElementById('bombs').value = 0;
        document.getElementById('bombVal').innerText = "0";
    }

    async function refreshGameData() {
        const { data } = await supabase.from('history').select('*').eq('session_name', currentSession).order('created_at', { ascending: false });
        let s = { A: 0, E: 0, D: 0 };
        data?.forEach(h => {
            const isWin = h.win_loss === 'è´';
            const p = h.points;
            if(h.landlord === 'A') { s.A += (isWin?p*2:-p*2); s.E += (isWin?-p:p); s.D += (isWin?-p:p); }
            else if(h.landlord === 'E') { s.E += (isWin?p*2:-p*2); s.A += (isWin?-p:p); s.D += (isWin?-p:p); }
            else if(h.landlord === 'D') { s.D += (isWin?p*2:-p*2); s.A += (isWin?-p:p); s.E += (isWin?-p:p); }
        });
        document.getElementById('scoreA').innerText = s.A;
        document.getElementById('scoreE').innerText = s.E;
        document.getElementById('scoreD').innerText = s.D;
        
        document.getElementById('roundHistory').innerHTML = data.map(h => `
            <div class="history-item">
                <span>${h.landlord} ${h.win_loss} ${h.points}åˆ† (by ${h.added_by})</span>
                <button class="btn-del" onclick="deleteRound('${h.id}')">åˆªé™¤</button>
            </div>
        `).join('');
    }

    async function deleteRound(id) {
        if(!confirm("åˆªé™¤é€™å›åˆï¼Ÿ")) return;
        await supabase.from('history').delete().eq('id', id);
        refreshGameData();
    }

    // åˆå§‹åŒ–
    fetchSessions();
    // å³æ™‚ç›£è½
    supabase.channel('any').on('postgres_changes', { event: '*', schema: 'public' }, () => {
        if(document.getElementById('lobbyPage').classList.contains('active')) fetchSessions();
        if(document.getElementById('gamePage').classList.contains('active')) refreshGameData();
    }).subscribe();

</script>
</body>
</html>

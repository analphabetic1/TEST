<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¬¥åœ°ä¸»å°ˆæ¥­è¨ˆåˆ†ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #4a90e2; --success: #4caf50; --danger: #f44336; --bg: #f4f7f9; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; padding-bottom: 50px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h3 { margin-top: 0; font-size: 1rem; color: #555; }

        /* æ–¹å¡Šå¼é¸æ“‡å™¨ (åœ°ä¸»/è´å®¶) */
        .box-selector { display: flex; gap: 10px; margin: 10px 0; }
        .box-item { flex: 1; padding: 12px; border: 2px solid #eee; border-radius: 10px; text-align: center; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .box-item.active { border-color: var(--primary); background: #eef5ff; color: var(--primary); }
        .box-item.winner.active { border-color: var(--success); background: #f0f9f0; color: var(--success); }

        /* æ»‘æ¡¿æ¨£å¼ */
        .range-container { display: flex; align-items: center; gap: 15px; margin: 20px 0; }
        input[type="range"] { flex: 1; }

        /* æ­·å²ç´€éŒ„èˆ‡åˆªé™¤ */
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .del-btn { background: #ffeded; color: var(--danger); border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; }
        
        .session-tag { font-size: 0.7rem; background: #eee; padding: 2px 6px; border-radius: 4px; margin-right: 5px; }
        .btn-main { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1rem; }
    </style>
</head>
<body>

<div style="max-width: 500px; margin: auto;">
    <div class="card">
        <h3>ğŸ“… è³½å±€è¨­å®š</h3>
        <input type="text" id="sessionName" placeholder="ä¾‹å¦‚ï¼š0101æœ‹å‹èšæœƒ" style="width:100%; padding:10px; box-sizing:border-box; border-radius:8px; border:1px solid #ddd; margin-bottom:10px;">
        <div class="box-selector" id="meSelector">
            <div class="box-item" onclick="setMe('A')">æˆ‘æ˜¯ A</div>
            <div class="box-item" onclick="setMe('E')">æˆ‘æ˜¯ E</div>
            <div class="box-item" onclick="setMe('D')">æˆ‘æ˜¯ D</div>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“Š <span id="currentSessionTitle">ç•¶å‰</span> ç´¯ç©ç¸½åˆ†</h3>
        <div style="display: flex; justify-content: space-around; font-size: 1.2rem; font-weight: bold;">
            <div style="text-align:center">A<br><span id="scoreA" style="color:var(--primary)">0</span></div>
            <div style="text-align:center">E<br><span id="scoreE" style="color:var(--primary)">0</span></div>
            <div style="text-align:center">D<br><span id="scoreD" style="color:var(--primary)">0</span></div>
        </div>
    </div>

    <div class="card">
        <h3>ğŸƒ åœ°ä¸»æ˜¯èª°ï¼Ÿ</h3>
        <div class="box-selector" id="landlordSelector">
            <div class="box-item" onclick="setLandlord('A')">A</div>
            <div class="box-item" onclick="setLandlord('E')">E</div>
            <div class="box-item" onclick="setLandlord('D')">D</div>
        </div>

        <h3>ğŸ† èª°è´äº†ï¼Ÿ</h3>
        <div class="box-selector" id="winnerSelector">
            <div class="box-item winner" onclick="setWinner('landlord')">åœ°ä¸»è´</div>
            <div class="box-item winner" onclick="setWinner('farmers')">è¾²æ°‘è´</div>
        </div>

        <div style="margin-top:20px;">
            <span>ğŸš€ ç«ç®­ x2 <input type="checkbox" id="rocket"></span> | 
            <span>ğŸŒ¸ æ˜¥å¤© x2 <input type="checkbox" id="spring"></span>
        </div>

        <div class="range-container">
            <span>ğŸ’£ ç‚¸å½ˆ: <b id="bombVal">0</b></span>
            <input type="range" id="bombs" min="0" max="7" value="0" oninput="bombVal.innerText=this.value">
        </div>

        <button class="btn-main" onclick="submitGame()">ç¢ºèªæäº¤é€™å±€</button>
    </div>

    <div class="card">
        <h3>ğŸ“œ æœ€è¿‘ 10 å±€ç´€éŒ„</h3>
        <div id="historyList">è¼‰å…¥ä¸­...</div>
    </div>
</div>

<script>
    const SB_URL = "https://mmnauzvhnguffpmevrup.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tbmF1enZobmd1ZmZwbWV2cnVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MjI1NjcsImV4cCI6MjA4MzE5ODU2N30.8GUyft8yVecvju7ecjcBwt1j2aqDL-WjThLA17iOcoE";
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    let myName = "", selectedLandlord = "", selectedWinner = "";

    function setMe(val) { myName = val; highlight('meSelector', val, 'æˆ‘æ˜¯ '); }
    function setLandlord(val) { selectedLandlord = val; highlight('landlordSelector', val); }
    function setWinner(val) { selectedWinner = val; highlight('winnerSelector', val === 'landlord' ? 'åœ°ä¸»è´' : 'è¾²æ°‘è´'); }

    function highlight(containerId, text, prefixText = "") {
        document.querySelectorAll(`#${containerId} .box-item`).forEach(el => {
            el.classList.toggle('active', el.innerText === prefixText + text);
        });
    }

    async function refresh() {
        const session = document.getElementById('sessionName').value || 'é è¨­è³½å±€';
        document.getElementById('currentSessionTitle').innerText = session;

        // æŠ“å–è©²å¤§å±€çš„æ‰€æœ‰æ­·å²ç´€éŒ„ä¾†è¨ˆç®—ç¸½åˆ†
        const { data: history } = await supabaseClient.from('history').select('*').eq('session_name', session);
        
        let scores = { A: 0, E: 0, D: 0 };
        if (history) {
            history.forEach(h => {
                // è¨ˆç®—é‚è¼¯ï¼šæ¯ä¸€ç­†ç´€éŒ„éƒ½è¦åˆ†é…çµ¦ä¸‰å€‹äºº
                // é€™è£¡ç°¡åŒ–ï¼šæˆ‘å€‘åœ¨è³‡æ–™åº«å­˜ A_change, E_change, D_change æ¬„ä½æœƒæ›´æº–ç¢ºï¼Œ
                // ä½†ç‚ºäº†ä¸æ”¹è¡¨çµæ§‹ï¼Œæˆ‘å€‘é€™è£¡å³æ™‚ç®—
                // [è¨»ï¼šå»ºè­°åœ¨ submit æ™‚ç›´æ¥ç®—å¥½å„äººå¾—åˆ†å­˜å…¥ï¼Œæ­¤è™•å…ˆæŠ“å–ç´€éŒ„é¡¯ç¤º]
            });
            // é€™è£¡é¡¯ç¤ºæœ€è¿‘ç´€éŒ„
            renderHistory(history.slice(-10).reverse());
            // ç”±æ–¼ç¸½åˆ†è¨ˆç®—è¼ƒè¤‡é›œï¼Œå»ºè­°åŸ·è¡Œ updateScoresDisplay()
        }
        updateTotalScores(session);
    }

    async function updateTotalScores(session) {
        const { data } = await supabaseClient.from('history').select('points, landlord, win_loss').eq('session_name', session);
        let s = { A: 0, E: 0, D: 0 };
        data?.forEach(h => {
            const p = h.points;
            const isWin = h.win_loss === 'è´';
            if(h.landlord === 'A') { s.A += (isWin?p*2:-p*2); s.E += (isWin?-p:p); s.D += (isWin?-p:p); }
            else if(h.landlord === 'E') { s.E += (isWin?p*2:-p*2); s.A += (isWin?-p:p); s.D += (isWin?-p:p); }
            else if(h.landlord === 'D') { s.D += (isWin?p*2:-p*2); s.A += (isWin?-p:p); s.E += (isWin?-p:p); }
        });
        document.getElementById('scoreA').innerText = s.A;
        document.getElementById('scoreE').innerText = s.E;
        document.getElementById('scoreD').innerText = s.D;
    }

    async function submitGame() {
        const session = document.getElementById('sessionName').value || 'é è¨­è³½å±€';
        if (!myName || !selectedLandlord || !selectedWinner) return alert("è«‹å®Œæˆæ‰€æœ‰é¸æ“‡ï¼");
        
        const bombs = parseInt(document.getElementById('bombs').value);
        const rocket = document.getElementById('rocket').checked;
        const spring = document.getElementById('spring').checked;
        const points = 10 * Math.pow(2, bombs + (rocket?1:0) + (spring?1:0));

        await supabaseClient.from('history').insert([{
            session_name: session,
            added_by: myName,
            landlord: selectedLandlord,
            win_loss: selectedWinner === 'landlord' ? 'è´' : 'è¼¸',
            points: points,
            bombs: bombs,
            is_rocket: rocket,
            is_spring: spring
        }]);
        refresh();
    }

    async function deleteRecord(id) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) return;
        await supabaseClient.from('history').delete().eq('id', id);
        refresh();
    }

    function renderHistory(data) {
        document.getElementById('historyList').innerHTML = data.map(h => `
            <div class="history-item">
                <div>
                    <span class="session-tag">${h.session_name}</span>
                    <b>${h.landlord}</b> ${h.win_loss} ${h.points}åˆ†
                    <small>(by ${h.added_by})</small>
                </div>
                <button class="del-btn" onclick="deleteRecord('${h.id}')">åˆªé™¤</button>
            </div>
        `).join('');
    }

    // åˆå§‹åŒ–èˆ‡ç›£è½
    refresh();
    supabaseClient.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'history' }, () => refresh()).subscribe();
</script>
</body>
</html>

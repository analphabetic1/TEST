<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ‹å‹é¬¥åœ°ä¸»è¨ˆåˆ†å™¨ v3</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* å›æ­¸ç¬¬ä¸€ç‰ˆç°¡ç´„é¢¨æ ¼ */
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .page { display: none; max-width: 500px; margin: auto; }
        .page.active { display: block; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        h2 { text-align: center; color: #1890ff; margin-bottom: 20px; }
        h3 { margin-top: 0; font-size: 1rem; color: #666; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        /* è¨ˆåˆ†æ¿æ¨£å¼ */
        .score-board { display: flex; justify-content: space-around; margin: 15px 0; }
        .player { text-align: center; }
        .score { font-size: 24px; font-weight: bold; color: #1890ff; }

        /* æ–¹å¡Šé¸æ“‡å™¨ */
        .box-selector { display: flex; gap: 8px; margin: 10px 0; }
        .box-item { flex: 1; padding: 12px 5px; border: 1px solid #ddd; border-radius: 5px; text-align: center; cursor: pointer; font-weight: bold; }
        .box-item.active { border-color: #1890ff; color: #1890ff; background: #e6f7ff; }
        .box-item.winner.active { border-color: #52c41a; color: #52c41a; background: #f6ffed; }

        /* è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• */
        input, select, button { padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ddd; }
        .btn-main { background: #1890ff; color: white; border: none; cursor: pointer; width: 100%; font-size: 1rem; font-weight: bold; padding: 15px; margin-top: 20px; }
        .btn-ghost { background: transparent; color: #1890ff; border: 1px solid #1890ff; width: auto; padding: 5px 15px; margin-bottom: 15px; }
        
        /* æ­·å²ç´€éŒ„ */
        .history-item { border-bottom: 1px solid #f0f0f0; padding: 10px 0; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .history-item.deleted { text-decoration: line-through; color: #ccc; }
        .del-tag { font-size: 0.7rem; color: #ff4d4f; margin-left: 5px; }
        .del-btn { background: #ff4d4f; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
        
        .session-item { display: flex; justify-content: space-between; padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px; cursor: pointer; border: 1px solid #eee; }
    </style>
</head>
<body>

    <div id="lobbyPage" class="page active">
        <h2>ğŸ´ é¬¥åœ°ä¸»è¨ˆåˆ†å¤§å»³</h2>
        <div class="card">
            <h3>æ–°å¢è³½å±€</h3>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <input type="text" id="newSessionInput" placeholder="è³½å±€åç¨± (å¦‚ 0101)">
                <div style="display:flex; align-items:center; gap:10px;">
                    åº•åˆ†ï¼š<input type="number" id="baseScoreInput" value="10" style="width:80px;">
                </div>
                <button class="btn-main" onclick="createSession()">å»ºç«‹è³½å±€</button>
            </div>
        </div>
        <div id="sessionList">é€£ç·šä¸­...</div>
    </div>

    <div id="gamePage" class="page">
        <button class="btn-ghost" onclick="showLobby()">â¬… è¿”å›å¤§å»³</button>
        <div class="card">
            <h2 id="currentSessionTitle" style="margin:0 0 10px 0; font-size:1.2rem;">---</h2>
            <div class="score-board">
                <div class="player">A<div id="scoreA" class="score">0</div></div>
                <div class="player">E<div id="scoreE" class="score">0</div></div>
                <div class="player">D<div id="scoreD" class="score">0</div></div>
            </div>
        </div>

        <div class="card">
            <h3>æˆ‘æ˜¯èª°ï¼Ÿ</h3>
            <div class="box-selector" id="meSelector">
                <div class="box-item" onclick="setMe('A', this)">A</div>
                <div class="box-item" onclick="setMe('E', this)">E</div>
                <div class="box-item" onclick="setMe('D', this)">D</div>
            </div>

            <h3>åœ°ä¸»</h3>
            <div class="box-selector" id="landlordSelector">
                <div class="box-item" onclick="setLandlord('A', this)">A</div>
                <div class="box-item" onclick="setLandlord('E', this)">E</div>
                <div class="box-item" onclick="setLandlord('D', this)">D</div>
            </div>

            <h3>çµæœ</h3>
            <div class="box-selector" id="winnerSelector">
                <div class="box-item winner" onclick="setWinner('landlord', this)">åœ°ä¸»è´</div>
                <div class="box-item winner" onclick="setWinner('farmers', this)">è¾²æ°‘è´</div>
            </div>

            <div style="margin:15px 0; font-size:0.9rem;">
                ğŸš€<input type="checkbox" id="rocket"> ç«ç®­ | ğŸŒ¸<input type="checkbox" id="spring"> æ˜¥å¤© | ğŸ’£ç‚¸å½ˆ: <b id="bombVal" style="color:red">0</b>
                <input type="range" id="bombs" min="0" max="7" value="0" style="width:100%" oninput="bombVal.innerText=this.value">
            </div>

            <button class="btn-main" onclick="submitRound()">æäº¤ç´€éŒ„</button>
        </div>

        <div class="card">
            <h3>æœ¬å±€æ­·å²ç´€éŒ„</h3>
            <div id="roundHistory"></div>
        </div>
    </div>

<script>
    const SB_URL = "https://mmnauzvhnguffpmevrup.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tbmF1enZobmd1ZmZwbWV2cnVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MjI1NjcsImV4cCI6MjA4MzE5ODU2N30.8GUyft8yVecvju7ecjcBwt1j2aqDL-WjThLA17iOcoE";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let currentSession = "", currentBase = 10, myName = "", selectedLandlord = "", selectedWinner = "";

    function showLobby() {
        document.getElementById('lobbyPage').classList.add('active');
        document.getElementById('gamePage').classList.remove('active');
        fetchSessions();
    }

    async function fetchSessions() {
        const { data } = await _supabase.from('sessions').select('*').order('created_at', { ascending: false });
        const list = document.getElementById('sessionList');
        list.innerHTML = data?.map(s => `
            <div class="session-item" onclick="enterSession('${s.name}', ${s.base_score})">
                <div><b>${s.name}</b> <small style="color:#999">(åº•åˆ†:${s.base_score})</small></div>
                <span style="color:#1890ff">é€²å…¥ ></span>
            </div>
        `).join('') || "ç›®å‰ç„¡è³½å±€";
    }

    async function createSession() {
        const name = document.getElementById('newSessionInput').value.trim();
        const base = parseInt(document.getElementById('baseScoreInput').value);
        if(!name) return alert("è«‹è¼¸å…¥åç¨±");
        const { error } = await _supabase.from('sessions').insert([{ name, base_score: base }]);
        if(error) alert("å»ºç«‹å¤±æ•—: " + error.message);
        else { document.getElementById('newSessionInput').value = ""; fetchSessions(); }
    }

    function enterSession(name, base) {
        currentSession = name; currentBase = base;
        document.getElementById('currentSessionTitle').innerText = `è³½å±€ï¼š${name} (åº•åˆ†:${base})`;
        document.getElementById('lobbyPage').classList.remove('active');
        document.getElementById('gamePage').classList.add('active');
        refreshGameData();
    }

    function setMe(v, el) { myName = v; highlight('meSelector', el); }
    function setLandlord(v, el) { selectedLandlord = v; highlight('landlordSelector', el); }
    function setWinner(v, el) { selectedWinner = v; highlight('winnerSelector', el); }
    function highlight(pId, el) {
        document.querySelectorAll(`#${pId} .box-item`).forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }

    async function submitRound() {
        if(!myName || !selectedLandlord || !selectedWinner) return alert("è«‹é¸æ“‡æˆ‘æ˜¯èª°ã€åœ°ä¸»èˆ‡çµæœ");
        const bombs = parseInt(document.getElementById('bombs').value);
        const power = bombs + (document.getElementById('rocket').checked ? 1 : 0) + (document.getElementById('spring').checked ? 1 : 0);
        // è¨ˆç®—ç¸½å¾—åˆ† (é€™å±€åœ°ä¸»è´å¤šå°‘ï¼Œè¾²æ°‘å°±å„æ‰£ä¸€åŠ)
        const roundPoints = currentBase * Math.pow(2, power);

        await _supabase.from('history').insert([{
            session_name: currentSession, added_by: myName, landlord: selectedLandlord,
            win_loss: selectedWinner === 'landlord' ? 'è´' : 'è¼¸',
            points: roundPoints
        }]);
        
        refreshGameData();
        // é‡ç½®
        document.getElementById('bombs').value = 0;
        document.getElementById('bombVal').innerText = "0";
        document.getElementById('rocket').checked = false;
        document.getElementById('spring').checked = false;
    }

    async function refreshGameData() {
        const { data } = await _supabase.from('history').select('*').eq('session_name', currentSession).order('created_at', { ascending: false });
        let s = { A: 0, E: 0, D: 0 };
        
        data?.forEach(h => {
            if(h.is_deleted) return; // åˆªé™¤çš„ä¸è¨ˆå…¥åˆ†æ•¸
            const isWin = h.win_loss === 'è´';
            const p = h.points; // é€™æ˜¯è¾²æ°‘è¼¸è´çš„åŸºæº–åˆ†
            
            // åœ°ä¸»è´ï¼šåœ°ä¸» +2p, è¾²æ°‘å„ -p
            // åœ°ä¸»è¼¸ï¼šåœ°ä¸» -2p, è¾²æ°‘å„ +p
            if(h.landlord === 'A') { s.A += (isWin?p*2:-p*2); s.E += (isWin?-p:p); s.D += (isWin?-p:p); }
            else if(h.landlord === 'E') { s.E += (isWin?p*2:-p*2); s.A += (isWin?-p:p); s.D += (isWin?-p:p); }
            else if(h.landlord === 'D') { s.D += (isWin?p*2:-p*2); s.A += (isWin?-p:p); s.E += (isWin?-p:p); }
        });

        document.getElementById('scoreA').innerText = s.A;
        document.getElementById('scoreE').innerText = s.E;
        document.getElementById('scoreD').innerText = s.D;

        document.getElementById('roundHistory').innerHTML = data.map(h => `
            <div class="history-item ${h.is_deleted ? 'deleted' : ''}">
                <span>
                    ${h.landlord}${h.win_loss} ${h.points * 2}åˆ† 
                    ${h.is_deleted ? `<span class="del-tag">å·²ç”± ${h.deleted_by} åˆªé™¤</span>` : `<small style="color:#999; margin-left:5px;">by ${h.added_by}</small>`}
                </span>
                ${!h.is_deleted ? `<button class="del-btn" onclick="deleteRound('${h.id}')">åˆªé™¤</button>` : ''}
            </div>
        `).join('');
    }

    async function deleteRound(id) {
        if(!myName) return alert("è«‹å…ˆé¸æ“‡ä½ æ˜¯èª°(æ“ä½œè€…)ï¼Œæ‰èƒ½é€²è¡Œåˆªé™¤");
        if(confirm("ç¢ºå®šåˆªé™¤é€™å›åˆä¸¦ä¿ç•™ç´€éŒ„å—ï¼Ÿ")) {
            await _supabase.from('history').update({ is_deleted: true, deleted_by: myName }).eq('id', id);
            refreshGameData();
        }
    }

    fetchSessions();
    _supabase.channel('any').on('postgres_changes', { event: '*', schema: 'public' }, () => {
        if(document.getElementById('lobbyPage').offsetParent) fetchSessions();
        if(document.getElementById('gamePage').offsetParent) refreshGameData();
    }).subscribe();
</script>
</body>
</html>
